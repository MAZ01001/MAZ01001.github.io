<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="[MAZ01001.github.io] Colored bouncing ball screensaver with HTML5">
    <meta name="author" content="MAZ01001">
    <link rel="apple-touch-icon" sizes="180x180" href="../img/apple-touch-icon.png">
    <link rel="icon" type="image/x-icon" href="../img/MAZ_logo.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="../img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../img/favicon-16x16.png">
    <link rel="manifest" href="../img/site.webmanifest">
    <link rel="mask-icon" href="../img/safari-pinned-tab.svg" color="#ff9900">
    <link rel="shortcut icon" href="../img/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="../img/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <title>Screensaver</title>
    <style>
        body{
            background-color: #222;
            padding: 0;
            margin: 0 auto;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <script>
        "use strict";
        //~ ______ _   _ _____
        //~ | ___ \ \ | |  __ \
        //~ | |_/ /  \| | |  \/
        //~ |    /| . ` | | __
        //~ | |\ \| |\  | |_\ \
        //~ \_| \_\_| \_/\____/
        /**
         * __a class to get random numbers like `Math.random` but seed-able__ \
         * uses `MurmurHash3` for initial seed and `sfc32` for generating values
         * @example new RNG("seed").value; //=> 0.8370377509475307
         * @author MAZ <https://MAZ01001.GitHub.io/>
         */
        const RNG=class{
            /**@type {number} - [private] first internal rng value*/
            _a_=0;
            /**@type {number} - [private] second internal rng value*/
            _b_=0;
            /**@type {number} - [private] third internal rng value*/
            _c_=0;
            /**@type {number} - [private] fourth internal rng value*/
            _d_=0;
            /**
             * __get the current state__ \
             * four 32bit numbers (one 128bit number)
             * @returns {readonly[number,number,number,number]} current state as four 32bit numbers (one 128bit number)
             */
            get state(){
                "use strict";
                return Object.freeze([this._a_,this._b_,this._c_,this._d_]);
            }
            /**
             * __create a new `RNG` object__
             * @param {string?} seed - a string used as the seed (via `cyrb128`) - defaults to current timestamp (in hex)
             * @returns {RNG} a new `RNG` object with the given seed
             * @example new RNG("seed").value; //=> 0.8370377509475307
             * @throws {TypeError} - if `seedString` is not a string (not when it is null/undefined)
             */
            constructor(seed){
                "use strict";
                if(seed==null)seed=Date.now().toString(0x10);
                if(typeof seed!=="string")throw new TypeError("[RNG::constructor] seedString is not a string");
                [this._a_,this._b_,this._c_,this._d_]=RNG._generateSeed_(seed);
            }
            /**
             * __creates a new `RNG` object with given state__
             * @param {[number,number,number,number]} state - custom state (for sfc32) - must be four 32bit numbers
             * @returns {RNG} new `RNG` object with given state
             */
            static from(state){
                "use strict";
                if(!Array.isArray(state))throw new TypeError("[RNG::from] state is not an array");
                if(state.length!==4)throw new TypeError("[RNG::from] state is not an array with four values");
                if(state.some(v=>typeof v!=="number"))throw new TypeError("[RNG::from] state is not an array with four numbers");
                if(state.some(v=>v<0||v>0xFFFFFFFF))throw new TypeError("[RNG::from] state is not an array with four 32bit numbers");
                const rng=new RNG("");
                [rng._a_,rng._b_,rng._c_,rng._d_]=state;
                return rng;
            }
            /**
             * __[private] creates a 128 bit seed from the given string__ \
             * using `MurmurHash3`
             * @param {string} str - a string
             * @returns {readonly[number,number,number,number]} an array of four 32bit integers (one 128bit integer seed)
             * @throws {TypeError} - if `str` is not a string
             */
            static _generateSeed_(str){
                "use strict";
                if(typeof str!=="string")throw new TypeError("[RNG::_generateSeed_] str is not a string");
                let h=0x811C9DC5>>>0;
                for(let i=0;i<str.length;i++){
                    const char=(k=>(k<<0xF)|(k>>>0x11))(Math.imul(str.charCodeAt(i),0xCC9E2D51));
                    h^=Math.imul(char,0x1B873593);
                    h=(h<<0xD)|(h>>>0x13);
                    h=(Math.imul(h,5)+0xE6546B64)|0;
                }
                h^=str.length;
                const seed=()=>{
                    h^=h>>>0x10;
                    h=Math.imul(h,0x85EBCA6B);
                    h^=h>>>0xD;
                    h=Math.imul(h,0xC2B2AE35);
                    h^=h>>>0x10;
                    return h>>>0;
                };
                return Object.freeze([seed(),seed(),seed(),seed()]);
            }
            /**
             * __get the next random 32bit value__ \
             * using `sfc32`
             * @returns {number} a random 32bit unsigned integer
             */
            get value32bit(){
                "use strict";
                this._a_|=0;
                this._b_|=0;
                this._c_|=0;
                this._d_|=0;
                let val=(((this._a_+this._b_)|0)+this._d_)|0;
                this._d_=(++this._d_)|0;
                this._a_=this._b_^(this._b_>>>9);
                this._b_=(this._c_+(this._c_<<3))|0;
                this._c_=(this._c_<<0x15)|(this._c_>>>0xB);
                this._c_=(this._c_+val)|0;
                return val>>>0;
            }
            /**
             * __get the next random value__
             * @returns {number} a random value between 0 and 1 (inclusive)
             */
            get value(){
                "use strict";
                return this.value32bit/0xFFFFFFFF;
            }
            /**
             * __get a random boolean value__
             * @returns {boolean} a random boolean value
             */
            get bool(){
                "use strict";
                return this.value32bit<0x10000;
            }
            /**
             * __get the next random value and translate it to given range__ \
             * _range is inclusive and gives a float_
             * @param {number} min - lower bound (inclusive)
             * @param {number} max - upper bound (inclusive)
             * @returns {number} random value within set range
             * @throws {TypeError} - if `min` or `max` are not finite numbers
             */
            range(min,max){
                "use strict";
                if(!((typeof min==="number")&&Number.isFinite(min)))throw new TypeError("[RNG::range] min is not a finite number");
                if(!((typeof max==="number")&&Number.isFinite(max)))throw new TypeError("[RNG::range] max is not a finite number");
                if(min===max)return min;
                return(this.value32bit*(max-min)+0xFFFFFFFF*min)/0xFFFFFFFF;
            }
        }
        //~  _   _______ _        ___                                       _
        //~ | | | | ___ \ |      / _ \                                     | |
        //~ | | | | |_/ / |     / /_\ \_ __ __ _ _   _ _ __ ___   ___ _ __ | |_ ___
        //~ | | | |    /| |     |  _  | '__/ _` | | | | '_ ` _ \ / _ \ '_ \| __/ __|
        //~ | |_| | |\ \| |____ | | | | | | (_| | |_| | | | | | |  __/ | | | |_\__ \
        //~  \___/\_| \_\_____/ \_| |_/_|  \__, |\__,_|_| |_| |_|\___|_| |_|\__|___/
        //~                                 __/ |
        //~                                |___/
        let _seed_=Math.floor(Date.now()/0xEA60).toString(0x10),//~ changes every minute
            _fpsView_=true,
            _clearCanvas_=true,
            _ballSize_=0.2,
            _ballSpeed_=0xF0,
            _colorSpeed_=0x3C,
            _img_=undefined,
            _imgPixelArt_=false,
            _imgReplace_=true;
        const args=window.location.search;
        if(args.length>1)
            for(const arg of args.substring(1).split('&'))
                switch(true){
                    case arg==="transparent=1":document.body.style.backgroundColor="transparent";break;
                    case /^fpsView=[01]$/.test(arg):_fpsView_=arg.substring(8)==='1';break;
                    case /^clearCanvas=[01]$/.test(arg):_clearCanvas_=arg.substring(0xC)==='1';break;
                    case /^ballSize=(?:1|0\.[0-9]{0,8}[1-9])$/.test(arg):_ballSize_=Number(arg.substring(9));break;
                    case /^ballSpeed=(?:0\.[0-9]{0,8}[1-9]|[1-9][0-9]*(?:\.[0-9]{1,9})?)$/.test(arg):if(Number.isFinite(Number(arg.substring(0xA))))_ballSpeed_=Number(arg.substring(0xA));break;
                    case /^colorSpeed=(?:0\.[0-9]{0,8}[1-9]|[1-9][0-9]*(?:\.[0-9]{1,9})?)$/.test(arg):if(Number.isFinite(Number(arg.substring(0xB))))_colorSpeed_=Number(arg.substring(0xB));break;
                    case /^seed=.*$/.test(arg):_seed_=arg.substring(5);break;
                    case /^img=.+$/.test(arg):_img_=decodeURIComponent(arg.substring(4));break;
                    case /^imgPixelArt=[01]$/.test(arg):_imgPixelArt_=arg.substring(0xC)==='1';break;
                    case /^imgOverrideBall=[01]$/.test(arg):_imgReplace_=arg.substring(0x10)==='1';break;
                }
        const showFPS=_fpsView_,
            clearCanvas=_clearCanvas_,
            ballSizePercent=_ballSize_,
            ballSpeed=_ballSpeed_,
            colorSpeed=_colorSpeed_,
            ballImg=_img_,
            ballImgPixelArt=_imgPixelArt_,
            ballImgReplace=_imgReplace_,
            rng=new RNG(_seed_);
        //~  _____      _
        //~ /  ___|    | |
        //~ \ `--.  ___| |_ _   _ _ __
        //~  `--. \/ _ \ __| | | | '_ \
        //~ /\__/ /  __/ |_| |_| | |_) |
        //~ \____/ \___|\__|\__,_| .__/
        //~                      | |
        //~                      |_|
        const canvasHTML=document.createElement("canvas"),
            img=document.createElement("img"),
            canvas=canvasHTML.getContext("2d"),
            ogFont=canvas.font;
        document.body.appendChild(canvasHTML);
        canvasHTML.width=innerWidth;
        canvasHTML.height=innerHeight;
        window.addEventListener("resize",()=>{
            "use strict";
            canvasHTML.width=innerWidth;
            canvasHTML.height=innerHeight;
        },{passive:true});
        let direction=[
                rng.bool,
                rng.bool
            ],
            position=(ballSize=>[
                rng.range(ballSize,window.innerWidth-ballSize),
                rng.range(ballSize,window.innerHeight-ballSize)
            ])((canvasHTML.width>canvasHTML.height?canvasHTML.height:canvasHTML.width)*ballSizePercent*0.5),
            lastFrameTime=0,
            colorHue=0x78,
            drawImg=false,
            fps=0x3C;
        if(ballImg!=null){
            if(ballImgPixelArt)img.style.imageRendering="pixelated";
            img.addEventListener("load",()=>drawImg=true,{passive:true,once:true});
            img.src=ballImg;
        }
        //~ ______
        //~ |  _  \
        //~ | | | |_ __ __ ___      __
        //~ | | | | '__/ _` \ \ /\ / /
        //~ | |/ /| | | (_| |\ V  V /
        //~ |___/ |_|  \__,_| \_/\_/
        /**@type {(n:number,min:number,max:number)=>number} - clamps a number to given range*/
        const clamp=(n,min,max)=>n<min?min:(n>max?max:n);
        /**@type {(deltaTime:number)=>void} - renders one frame on `canvas`*/
        const draw=deltaTime=>{
            "use strict";
            if(clearCanvas)canvas.clearRect(0,0,canvasHTML.width,canvasHTML.height);
            const ballSize=(canvasHTML.width>canvasHTML.height?canvasHTML.height:canvasHTML.width)*ballSizePercent*0.5;
            //~ ball direction
            if(position[0]+ballSize>window.innerWidth)direction[0]=false;
            else if(position[0]-ballSize<0)direction[0]=true;
            if(position[1]+ballSize>window.innerHeight)direction[1]=false;
            else if(position[1]-ballSize<0)direction[1]=true;
            //~ ball position
            if(ballSize*2===window.innerWidth)position[0]=ballSize;
            else{
                position[0]+=ballSpeed*deltaTime*(direction[0]?1:-1);
                position[0]=clamp(position[0],0,window.innerWidth);
            }
            if(ballSize*2===window.innerHeight)position[1]=ballSize;
            else{
                position[1]+=ballSpeed*deltaTime*(direction[1]?1:-1);
                position[1]=clamp(position[1],0,window.innerHeight);
            }
            //~ draw ball &/ img
            const[imgW,imgH]=(()=>{
                if(img.width>img.height)return[ballSize,ballSize*(img.height/img.width)];
                if(img.width<img.height)return[ballSize*(img.width/img.height),ballSize];
                return[ballSize,ballSize];
            })();
            if(drawImg&&ballImgReplace)canvas.drawImage(img,position[0]-imgW,position[1]-imgH,imgW*2,imgH*2);
            else{
                canvas.beginPath();
                canvas.arc(position[0],position[1],ballSize,0,Math.PI*2);
                canvas.closePath();
                canvas.stroke();
                colorHue=(colorHue+colorSpeed*deltaTime)%0x168;
                canvas.fillStyle=`hsl(${colorHue}, 100%, 50%)`;
                canvas.fill();
                if(drawImg){
                    canvas.beginPath();
                    canvas.arc(position[0],position[1],ballSize,0,Math.PI*2);
                    canvas.closePath();
                    canvas.save();
                    canvas.clip();
                    canvas.drawImage(img,position[0]-imgW,position[1]-imgH,imgW*2,imgH*2);
                    canvas.restore();
                }
            }
            //~ draw fps
            if(showFPS){
                canvas.beginPath();
                canvas.font="20px consolas,monospace";
                canvas.fillStyle="#0f0";
                canvas.strokeText(`fps ${fps}`,15,30);
                canvas.fillText(`fps ${fps}`,15,30);
                canvas.closePath();
            }
        }
        //~  _
        //~ | |
        //~ | |     ___   ___  _ __
        //~ | |    / _ \ / _ \| '_ \
        //~ | |___| (_) | (_) | |_) |
        //~ \_____/\___/ \___/| .__/
        //~                   | |
        //~                   |_|
        let _previousFrameTimestamp_=0,
            _previousFPS_=[];
        const animationLoop=()=>{
            "use strict";
            window.requestAnimationFrame(frameTimestamp=>{
                "use strict";
                const frameTime=frameTimestamp-_previousFrameTimestamp_;
                _previousFrameTimestamp_=frameTimestamp;
                fps=_previousFPS_.length===0?0:Math.round(_previousFPS_.reduce((o,v)=>o+v)/_previousFPS_.length);
                draw(frameTime/0x3E8);
                for(let i=Math.min(_previousFPS_.length,9);i>0;i--)_previousFPS_[i]=_previousFPS_[i-1];
                _previousFPS_[0]=Math.round(0x3E8/frameTime);
                animationLoop();
            });
        }
        animationLoop();
        //~  _____       __
        //~ |_   _|     / _|
        //~   | | _ __ | |_ ___
        //~   | || '_ \|  _/ _ \
        //~  _| || | | | || (_) |
        //~  \___/_| |_|_| \___/
        console.groupCollapsed(
            "%c%s",
            "background-color:#000;color:#0F0;font-size:larger",
            "available URL parameters"
        );
            console.log(
                "%c%s",
                "background-color:#000;color:#0F0;font-family:consolas,monospace",
                [
                    "+-----------------+---------------------------------+-----------------------------------------------------------+-------------------------+",
                    "| parameter       | possible values                 | description                                               | default value           |",
                    "+-----------------+---------------------------------+-----------------------------------------------------------+-------------------------+",
                    "| transparent     | 0 or 1                          | make the background of the website transparent            | 0                       |",
                    "| fpsView         | 0 or 1                          | show fps                                                  | 1                       |",
                    "| clearCanvas     | 0 or 1                          | clears the canvas every frame                             | 1                       |",
                    "| seed            | any                             | set the seed for RNG                                      | minute timestamp in hex |",
                    "+-----------------+---------------------------------+-----------------------------------------------------------+-------------------------+",
                    "| ballSize        | 0.000000001 to 1.0              | set the ball size (%) relative to the smaller window size | 0.2                     |",
                    "| ballSpeed       | finite float (9 decimal digits) | set the speed of the ball in pixels peer second           | 240                     |",
                    "| colorSpeed      | finite float (9 decimal digits) | set the speed of the color shift in degrees peer second   | 60                      |",
                    "+-----------------+---------------------------------+-----------------------------------------------------------+-------------------------+",
                    "| img             | HTML image source (URL)         | put an image on the ball (encode value as URI component)  | none                    |",
                    "|                 | (encoded URI component)         |                                                           |                         |",
                    "| imgPixelArt     | 0 or 1                          | enable better renderer for pixel art                      | 0                       |",
                    "| imgOverrideBall | 0 or 1                          | when active replaces the ball with the image              | 1                       |",
                    "+-----------------+---------------------------------+-----------------------------------------------------------+-------------------------+"
                ].join('\n')
            );
        console.groupEnd();
    </script>
</body>
</html>
